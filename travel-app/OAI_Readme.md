# OpenAI App Integration Notes

This document explains how ChatGPT, the Skyward Rewards MCP server, and the React UI collaborate to deliver the travel experience.

## High-Level Flow

1. **ChatGPT session** loads the MCP server definition (defined in your `app.json` / manifest outside this repo).
2. **ChatGPT → MCP (list phase):** When the conversation begins, ChatGPT requests `list_tools`, `list_resources`, and `list_resource_templates`. The Python server responds with metadata for the `skyward-flight-offers` tool and its associated widget template URI.
3. **ChatGPT renders widget:** To materialize the UI, ChatGPT invokes `ReadResource` for `ui://widget/skyward-flight-offers.html`. The MCP server loads `app/dist/index.html`, inlines the JS/CSS bundles, and returns the markup as `text/html+skybridge`.
4. **User interaction:** Inside the ChatGPT client, the widget runs the React bundle exactly as it would in a browser, handling dropdown filters, checkout authentication, and confirmations locally.
5. **ChatGPT ↔ MCP (tool calls):** When the conversation or widget requires data refresh (e.g., cabin filtering initiated from messages or future automation), ChatGPT issues a `CallTool` request to `skyward-flight-offers`, optionally passing `{ "fareCabin": "Business Flex" }`. The MCP server filters the static flight catalog and returns both structured JSON and updated widget metadata.
6. **State hydration:** ChatGPT hydrates the widget using the structured payload, allowing the React bundle to display the same itineraries it would render when run standalone.

## Data Sources

- **Front-end assets:** Generated by `pnpm run build` (or `npm run build`) inside `app/`. The MCP server depends on the compiled `dist/index.html` plus its emitted JS/CSS files.
- **Flight data:** Currently sourced from the static `FLIGHTS` dictionary in `mcp/travel_mcp.py`. Replace this with live API calls to surface real-time offers; the structured payload format can remain unchanged.

## Execution Checklist

1. Build the UI: `cd app && pnpm install && pnpm run build`.
2. Start the MCP server: `cd ../mcp && source .venv/bin/activate && uvicorn travel_mcp:app --port 8000`.
3. Register the MCP endpoint with ChatGPT (developer settings → Model Context Protocol tools).
4. Open a new ChatGPT conversation and choose the Skyward Rewards tool; the widget will appear once ChatGPT reads the resource.

## Extending the Integration

- **Multiple tools:** Add more entries to the `widgets` list and corresponding handlers if you want ChatGPT to summon different widgets (e.g., hotel offers) from the same MCP server.
- **Live services:** Introduce REST or GraphQL clients inside `travel_mcp.py` to fetch live flight data. The widget’s structured response can be adapted without impacting ChatGPT’s ability to render the UI, as long as the schema remains JSON serializable.
- **Bi-directional messaging:** The structured content returned by `_call_tool_request` can include additional fields (e.g., loyalty balance) that the React app can read through the skybridge hydration layer.

## Troubleshooting Tips

- If the widget appears but does not reflect recent UI changes, rebuild the front-end and restart the MCP server (the HTML loader is cached with `@lru_cache`).
- If ChatGPT reports missing resources, verify that `app/dist/index.html` and its linked assets exist and that the MCP process has read access.
- When deploying, expose the MCP endpoint over HTTPS and ensure CORS is configured appropriately (the sample already enables permissive CORS via Starlette middleware).

